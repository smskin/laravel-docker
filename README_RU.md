# О проекте
Данный проект предлагает решение по контейнеризации Laravel проекта.

Продуктовое окружение автоматически прописывается в конфигурации балансировщика Traefik.

Структура решения:
- директория `./deploy` - содержит bash-скрипты для развертывания окружения без использования CI.
- директория `./docker` - содержит Docker-файлы, конфигурацию и docker-compose файлы.
- файл `.gitlab-ci.yml` -  используется для реализации CI через GitLab.

## Окружения

### Локальное окружение
Это окружение используется разработчиками при локальной разработке. При этом типе развертывания файловая система проекта будет примонтирована внутрь контейнера, что позволяет работать над проектом в IDE без необходимости пересобирать контейнеры при изменении файлов.

При локальном развертывании используется два docker-compose файла:
- `docker-compose.yml`
- `docker-compose.local.yml`

Используется переопределение конфигурации `docker-compose.yml` с помощью `docker-compose.local.yml`.

Развертывание происходит запуском одного из bash-скриптов в директории `./deploy/local`
- `bash.sh` - запуск shell. Позволяет запускать команды artisan.
- `install.sh` - изначальная инициализация окружения.
- `start.sh` - запуск окружения в Daemon mode.
- `stop.sh` - остановка окружения, запущенного в Daemon mode.

При развертывании будут запущены следующие сервисы:
- `nginx` - HTTP сервер.
- `php-fpm` - PHP-FPM сервер.
- `supervisor` - сервис, позволяющий запускать фоновые процессы.
- `redis` - Redis server.
- `postgres` - PostgreSQL server.

### Продуктовое окружение
Это окружение используется при развертывании на сервере. При этом типе развертывания происходит сборка самодостаточных контейнеров, не связанных с файловой системой проекта.

При развертывании используется два docker-compose файла:
- `docker-compose.yml`
- `docker-compose.production.yml`

В окружении создаются два volume:
- `laravel-app` (для директории `./storage/app`) -  позволяет шарить файловую систему хранилища между запущенными контейнерами.
- `laravel-log` (для директории `./storage/logs`) - позволяет хранить локальные логи.

При развертывании будут запущены следующие сервисы:
- `nginx` - HTTP сервер.
- `php-fpm` - PHP-FPM сервер.
- `supervisor` - сервис, позволяющий запускать фоновые процессы.
- `redis` - Redis server.

Это окружение настроено для автоматической интеграции с развернутым Traefik. То есть, при старте проекта он автоматически будет проксироваться через Traefik. Конфигурацию Traefik опишу отдельно.

### Окружение Gitlab CI
Это окружение используется для развертывания на сервере через механизмы GitLab CI.

Инициализация CI происходит с помощью файла `./gitlab-ci.yml`. Принцип аналогичен предыдущему типу развертывания, только используются следующие docker-compose файлы:
- `docker-compose.yml`
- `docker-compose.ci.yml`

## Конфигурация

### Подготовка основного сервиса
В файле `./docker/docker-compose.yml` описан сервис platform. От данного сервиса наследуются остальные контейнеры. 

В случае необходимости вы можете изменить конфигурацию:
- TZ - временная зона ОС контейнеров. По умолчанию берется из `.env` файла.
- INSTALL_BCMATH - флаг установки расширения php `bcmath`.
- INSTALL_PHPREDIS - флаг установки расширения php `redis`.
- INSTALL_OPCACHE - флаг установки расширения php `opcache`.
- INSTALL_IMAGEMAGICK - флаг установки расширения php `imagick`.
- INSTALL_EXIF - флаг установки расширения php `exif`.
- INSTALL_PCNTL - флаг установки расширения php `pcntl`.
- INSTALL_INTL - флаг установки расширения php `intl`.
- INSTALL_SOAP - флаг установки расширения php `soap`.
- INSTALL_PGSQL - флаг установки расширений php `pgsql` и `pdo_pgsql`.
- INSTALL_MYSQL - флаг установки расширения php `pdo_mysql`.
- INSTALL_GETTEXT - флаг установки расширения php `gettext`.
- INSTALL_SOCKETS - флаг установки расширения php `sockets`.
- INSTALL_MEMCACHED -флаг установки расширения php  `memcached`.
- INSTALL_PECL_SYNC - флаг установки расширения php `sync`.
- INSTALL_PECL_MONGODB - флаг установки расширения php `mongodb`.
- OPENSSL_ENABLE_GOST_SUPPORT - флаг установки кастомной сборки `openssl` с поддержкой ГОСТ криптографии 

### Локальное окружение

В корне проекта, в файле .env измените следующие переменные:
```text
DB_CONNECTION=pgsql
DB_HOST=postgres # подключаемся к развертываемому PostgreSQL серверу
DB_PORT=5432
DB_DATABASE=default
DB_USERNAME=default
DB_PASSWORD=secret

SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
CACHE_STORE=redis
REDIS_HOST=redis # подключаемся к развертываемому Redis серверу
```

В директории docker измените создайте .env файл (`./docker/.env`)
```text
COMPOSE_PROJECT_NAME=project-name # Дайте название проекту

TIMEZONE=Europe/Moscow # Временная зона сервера

### Nginx #####################################################
NGINX_HOST_IP=0.0.0.0 # IP разветываемого сервера. 0.0.0.0 - доступен из сети, 127.0.0.1 - доступен только локально
NGINX_HOST_PORT=82 # порт сервера, используйте для одновременного развертывания нескольких окружений

### PostgreSQL ################################################
POSTGRES_HOST_IP=0.0.0.0 # IP разветываемого сервера. 0.0.0.0 - доступен из сети, 127.0.0.1 - доступен только локально
POSTGRES_HOST_PORT=54322 # порт сервера, используйте для одновременного развертывания нескольких окружений
POSTGRES_DB=default # название БД по умолчанию
POSTGRES_USER=default # пользователь БД
POSTGRES_PASSWORD=secret # пароль БД

### Containers ################################################
CONTAINER_NAME_DELIMITER="-" # Разделитель имен образов. При использовании заметил, что Docker иногда дает имена образам через "-", а иногда через "_". Если при сборке у вас ошибка "Image not found", проверте наименование образов, возможно проблема в этой переменной
```

После настройки вы можете запустить `./deploy/local/install.sh` для сборки окружения. 
Далее используйте `./deploy/local/start.sh` для запуска.

### Продуктовое окружение

В корне проекта, в файле .env измените следующие переменные:
```text
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
CACHE_STORE=redis
REDIS_HOST=redis # подключаемся к развертываемому Redis серверу
```

В директории docker измените создайте .env файл (`./docker/.env`)
```text
COMPOSE_PROJECT_NAME=project-name # Дайте название проекту

TIMEZONE=Europe/Moscow # Временная зона сервера

### Nginx #####################################################
NGINX_TRAEFIK_DOMAIN=api.tg.starwords.ru # Домен проекта используется для проброса домена в Traefik

### Containers ################################################
CONTAINER_NAME_DELIMITER="-" # Разделитель имен образов. При использовании заметил, что Docker иногда дает имена образам через "-", а иногда через "_". Если при сборке у вас ошибка "Image not found", проверте наименование образов, возможно проблема в этой переменной
```

После настройки вы можете запустить `./deploy/production/install.sh` для сборки окружения.
Далее используйте `./deploy/production/start.sh` для запуска.

### Окружение Gitlab CI

В файле `gitlab-ci.yml` прописаны аргументы сборки контейнеров:
- TIMEZONE - Временная зона сервера
- CONTAINER_NAME_DELIMITER - Разделитель имен образов. При использовании заметил, что Docker иногда дает имена образам через "-", а иногда через "_". Если при сборке у вас ошибка "Image not found", проверте наименование образов, возможно проблема в этой переменной

В файле `./docker/docker-compose.ci.yml` находится блок проброса переменных `x-laravel-env`. Данный блок предназначен для проброса переменных окружения из "Gitlab CI\CD Variables" в запускаемые контейнеры.

Для описания выбран следующий формат:
`APP_NAME: ${LARAVEL_APP_NAME}` - читается как в перменную env `APP_NAME` помести содержимое переменной Gitlab `LARAVEL_APP_NAME`.

Вы можете расширять этот блок любыми, необходимыми вам, переменными.

То есть перед развертыванием нужно:
- описать все переменные, используемые в локальном `.env` файле, в блоке `x-laravel-env`
- наполнить Gitlab CI\CD Variables переменными
- запускать деплой

В данном примере задействованы следующие переменные - не забудьте их заполнить:
- LARAVEL_APP_NAME
- LARAVEL_APP_KEY
- DOMAIN
- LARAVEL_DB_CONNECTION
- LARAVEL_DB_HOST
- LARAVEL_DB_PORT
- LARAVEL_DB_DATABASE
- LARAVEL_DB_USERNAME
- LARAVEL_DB_PASSWORD

## Supervisor
Для описания конфигурации supervisor решил описать отдельный блок.  По умолчанию supervisor задействован только для `scheduled tasks`. 

Конфигурация находится в файле `./docker/supervisor/conf/supervisor/conf.d/laravel.conf`.

В конфигурации есть закоментированный блок, обеспечивающий работу библиотеки [`horizon`](https://laravel.com/docs/11.x/horizon).
Если вы используете данную библиотеку - раскоментируйте блок и пересоберите образ `supervisor`.

## Traefik
Для развертывания проектов мне нравится балансировщик [Traefik](https://traefik.io).

В директории `./docker/traefik` я подготовил готовую конфигурацию, которая:
- Ищет контейнеры по label и автоматически проксирует трафик в них по конфигурации этих контейнеров (то есть конфигурация описывается в сервисах, а не в Traefik). Это позволяет один раз развернуть Traefik и больше его не трогать.
- Автоматическое получение и продление сертификатов [Let`s encrypt](https://letsencrypt.org)

Установка:
- скопируйте содержимое директории `./docker/traefik` на свой сервер в любое место.
- создайте файл .env на базе `env.example` и измените в нем переменную `ADMIN_EMAIL`.
- запустите команду создания сети `docker network create traefik-net`.
- запустите `docker compose up -d`.
- вы можете проверить работоспособность, зайдя по адресу `http://{IP}:8080`.

*Обратите внимание: данная сборка слушает контейнеры в сети `traefik-net`. Если у вас не проксируется трафик, проверьте что контейнер подключен к сети `traefik-net`.*

После успешной настройки отредактируйте `docker-compose.yml`:
- Поменяйте `--log.level=DEBUG` на `--log.level=ERROR`
- Уберите проброску порта `8080:8080` из блока `ports`
- Перезапустите traefik (`docker compose down && docker compose up -d`)

## Добавление в уже существующий проект

- Скопируйте к себе в проект директории `./deploy` и `./docker`
- Скопируйте к себе в проект файл `gitlab-ci.yml`
- Настройте по инструкции выше
- Если скрипты из директории `./deploy` не будут запускаться, дайте команду на дачу привелений на исполнение `cd ./deploy/local && chmod +x *`
